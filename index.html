function update() {
        if (!isGameRunning) return;

        // 1. Сброс состояния
        // УДАЛЕНО: player.onGround = false; (Это ломало прыжок)
        player.onLadder = false;

        // 2. Управление движением (Объединяем клавиатуру и тач)
        player.vx = 0;
        const moveLeft = keys.left || keys.touchLeft;
        const moveRight = keys.right || keys.touchRight;
        
        if (moveLeft) player.vx = -player.speed;
        if (moveRight) player.vx = player.speed;

        // 3. Прыжок/Вверх (Объединяем)
        const shouldJump = keys.jump || keys.touchJump;
        const shouldClimbUp = keys.up || keys.touchUp;
        const shouldClimbDown = keys.down || keys.touchDown;

        // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ ЛОГИКИ ПРЫЖКА
        // Теперь проверка происходит ДО сброса onGround, используя значение с прошлого кадра
        if (shouldJump && player.onGround) {
            player.vy = -player.jumpPower;
            player.onGround = false;
        }
        
        // 4. Физика: Гравитация и Движение
        if (!player.onLadder) {
            player.vy += player.gravity;
            player.y += player.vy;
        }

        player.x += player.vx;
        
        // 5. ВЕРТИКАЛЬНЫЙ СКРОЛЛ (Бесконечное восхождение)
        const scrollThreshold = canvas.height * 0.4; 

        if (player.y < scrollThreshold) {
            const scrollAmount = scrollThreshold - player.y;
            player.y = scrollThreshold;
            
            platforms.forEach(p => p.y += scrollAmount);
            ladders.forEach(l => l.y += scrollAmount);
            enemies.forEach(e => e.y += scrollAmount);
            trampolines.forEach(t => t.y += scrollAmount);
        }

        if (platforms.length > 0 && platforms[platforms.length - 1].y > -50) {
            generateNewPlatforms(platforms[platforms.length - 1].y);
        }
        platforms = platforms.filter(p => p.y < canvas.height + 50);


        // 6. ОБНАРУЖЕНИЕ СТОЛКНОВЕНИЙ
        
        // ВАЖНО: Сбрасываем onGround здесь, перед новой проверкой столкновений
        player.onGround = false; 
        
        // Столкновение с Платформами (торты)
        for (const platform of platforms) {
            if (player.y + player.height > platform.y && 
                player.y < platform.y && 
                player.x + player.width > platform.x && 
                player.x < platform.x + platform.w &&
                player.vy >= 0) 
            {
                player.y = platform.y - player.height;
                player.vy = 0;
                player.onGround = true; // Если стоим, флаг станет true
            }
        }
        
        // Столкновение с Лестницами
        let touchingLadder = false;
        for (const ladder of ladders) {
             if (player.x + player.width > ladder.x && 
                 player.x < ladder.x + ladder.w && 
                 player.y + player.height > ladder.y && 
                 player.y < ladder.y + ladder.h) 
             {
                 touchingLadder = true;
             }
        }
        player.onLadder = touchingLadder;
        
        // Управление на Лестнице
        if (player.onLadder) {
             player.vy = 0; 
             if (shouldClimbUp) { 
                 player.y -= player.speed / 2;
             } else if (shouldClimbDown) { 
                 player.y += player.speed / 2;
             }
        } 
        
        // Столкновение с Батутами
        for (const tramp of trampolines) {
             if (player.y + player.height > tramp.y &&
                 player.y < tramp.y &&
                 player.x + player.width > tramp.x &&
                 player.x < tramp.x + tramp.w &&
                 player.vy >= 0) {
                 player.vy = -(player.jumpPower * tramp.jumpBoost);
             }
        }
        
        // 7. Столкновение с Врагами
        for (const enemy of enemies) {
             if (player.x < enemy.x + enemy.w &&
                 player.x + player.width > enemy.x &&
                 player.y < enemy.y + enemy.h &&
                 player.y + player.height > enemy.y) {
                 gameOver();
                 return;
             }
        }
        
        // 8. Смерть от падения
        if (player.y > canvas.height + 50) {
            gameOver();
        }
        
        // 9. Движение врагов
        for (const enemy of enemies) {
            enemy.x += enemy.vx;
        }

        // 10. Ограничение движения по горизонтали
        if (player.x < 0) player.x = 0;
        if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
    }
