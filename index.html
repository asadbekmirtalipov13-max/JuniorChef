<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junior Chef: Confectionary Line</title>
    <!-- Load Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7e6e6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        #app-container {
            width: 100%;
            max-width: 450px; /* Mobile vertical view */
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-radius: 1 lysates;
            overflow: hidden;
            position: relative;
        }
        /* Style for all game screens/views */
        .game-screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Intro Screen Specific Styles */
        #intro-screen {
            background-color: #000000;
            justify-content: space-between; 
            padding-top: 10vh; 
        }
        .intro-main-text {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
            font-size: 3.5rem; 
            line-height: 1; 
            color: #ffffff; 
            letter-spacing: 0.05em;
            margin: 0; 
            padding: 0;
            text-align: center; 
        }
        .intro-sub-text {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: #ffffff; 
            margin: 0; 
            padding: 0;
            line-height: 1; 
            margin-top: -5px; 
            position: relative;
            left: 5px; 
        }
        .intro-container {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            align-items: center; 
            padding-top: 20vh; 
        }
        #splashMessage {
             margin-top: 15vh;
             visibility: hidden;
        }
        .copyright-text {
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            font-size: 1rem;
            margin-bottom: 20px;
            color: #ffffff;
        }

        /* Main Menu Styles */
        #main-menu-screen {
            background-color: #fce7f3; /* Light pink background */
        }
        #main-menu-screen img {
             width: 150px;
             height: 150px;
             margin-bottom: 10px;
             filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2)); 
        }
        .main-title {
             font-size: 4rem;
             font-weight: 900;
             letter-spacing: 0; 
             line-height: 1;
             color: #db2777; /* –†–æ–∑–æ–≤—ã–π —Ü–≤–µ—Ç */
             text-shadow: none; 
             margin-bottom: 3rem;
        }

        /* Button Style */
        .menu-button {
            padding: 1rem 3rem;
            margin: 0.75rem 0;
            font-size: 1.5rem;
            font-weight: 700;
            border-radius: 9999px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.15s ease-in-out;
        }
        .menu-button:hover {
            transform: scale(1.05);
        }

        /* Game Screen Styles */
        #game-view {
            display: flex;
            flex-direction: column;
            background-color: #f0f0f0; 
            justify-content: flex-start;
        }
        #gameCanvas {
            background-color: #f7f7f7;
            touch-action: manipulation;
            flex-grow: 1;
        }

        /* Confetti Styles (new) */
        #confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 5;
        }
        .confetto {
            position: absolute;
            opacity: 0.8;
            border-radius: 2px;
            will-change: transform; 
            animation: fall linear infinite;
        }
        @keyframes fall {
            /* –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ú—è–≥–∫–æ–µ –ø–∞–¥–µ–Ω–∏–µ –∏ –≤—Ä–∞—â–µ–Ω–∏–µ –±–µ–∑ —Ä–∞–∑–º—ã—Ç–∏—è */
            0% {
                transform: translateY(-5%) rotate(0deg) translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg) translateX(0);
                opacity: 0;
            }
        }
        
        /* Settings Screen Styles */
        #settings-screen {
            background-color: #fce7f3;
        }
    </style>
</head>
<body>

<!-- –ê—É–¥–∏–æ –ø–ª–µ–µ—Ä –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏ -->
<audio id="background-music" loop>
    <!-- –í–ê–®–ê –°–°–´–õ–ö–ê –ù–ê MP3 (Sakura-Girl-Daisy-chosic.com_.mp3) -->
    <source src="uploaded:Sakura-Girl-Daisy-chosic.com_.mp3" type="audio/mpeg">
    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
</audio>

<div id="app-container">

    <!-- 1. INTRO SCREEN (Asonik Studios - Splash) -->
    <div id="intro-screen" class="game-screen text-white">
        
        <div class="intro-container">
            <h1 id="splashTitle" class="intro-main-text">Asonik Studios</h1>
            <p id="splashSubtitle" class="intro-sub-text">–ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç</p>
            <p id="splashMessage" class="text-gray-400 mt-4 text-sm mb-8">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...</p>
        </div>
        
        <p class="copyright-text">2025¬©</p>
    </div>

    <!-- 2. MAIN MENU SCREEN -->
    <div id="main-menu-screen" class="game-screen p-8 relative">
        <div id="confetti-container"></div> 

        <img src="https://i.ibb.co/tg4H6Sf/photo-2025-11-16-03-40-45.jpg" 
             alt="Cake Logo" 
             class="rounded-full shadow-xl mb-6">
        
        <h1 class="main-title font-black text-pink-600 text-center">JuniorChef</h1>
        
        <button id="playButton" class="menu-button bg-green-500 text-white hover:bg-green-600">
            –ò–ì–†–ê–¢–¨
        </button>
        <button id="settingsButton" class="menu-button bg-cyan-500 text-white hover:bg-cyan-600">
            –ù–ê–°–¢–†–û–ô–ö–ò
        </button>
    </div>

    <!-- 3. GAME VIEW (–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∏–≥—Ä–æ–π) -->
    <div id="game-view" class="game-screen">
        <!-- Score & Order Header -->
        <div class="w-full bg-yellow-400 text-gray-800 p-2 shadow-md flex justify-between items-center sticky top-0 z-10">
            <div class="text-sm font-semibold">–°–ß–ï–¢: <span id="scoreDisplay" class="text-lg font-extrabold">0</span></div>
            <div class="text-sm font-semibold">–ü–†–û–ì–†–ï–°–°: <span id="orderProgress" class="text-lg font-extrabold text-red-600">0 / 0</span></div>
        </div>
        
        <!-- Order Display (Visible above canvas) -->
        <div id="currentOrderDisplay" class="w-full bg-orange-200 p-2 text-center text-sm font-bold text-gray-700">
            –¢—Ä–µ–±—É–µ–º—ã–π —Ç–æ—Ä—Ç:
        </div>

        <!-- Canvas for the conveyor belt and cake -->
        <canvas id="gameCanvas"></canvas>
    </div>
    
    <!-- 4. SETTINGS SCREEN (–ù–û–í–´–ô –≠–ö–†–ê–ù) -->
    <div id="settings-screen" class="game-screen p-8">
        <h1 class="text-3xl font-black text-cyan-600 mb-6 text-center">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        
        <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–£–ó–´–ö–û–ô (–ù–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´) -->
        <div class="w-full max-w-sm p-4 bg-white rounded-lg shadow-md mb-8 text-sm text-gray-700">
            <p class="text-lg font-semibold mb-3">–ú—É–∑—ã–∫–∞ –∏ –ó–≤—É–∫</p>

            <div class="flex justify-between items-center mb-4">
                <label for="volume-slider" class="font-semibold">–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
                <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5" class="w-2/3">
            </div>

            <button id="toggle-music-btn" class="w-full py-2 rounded-lg font-bold transition-colors duration-150 bg-green-500 hover:bg-green-600 text-white">
                –ú—É–∑—ã–∫–∞: –í–∫–ª.
            </button>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ -->
        <div class="w-full max-w-sm p-4 bg-white rounded-lg shadow-md mb-8 text-sm text-gray-700">
            <p class="text-lg font-semibold mb-2">–°—Ç–∞—Ç—É—Å:</p>
            <p class="text-red-500 font-bold mb-3">–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</p>
            
            <hr class="mb-3">
            
            <p class="font-semibold">–í–∞—à ID:</p>
            <p id="displayUserIdSettings" class="font-mono text-xs text-gray-500 break-all">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        
        <button id="backToMenuButton" class="menu-button bg-pink-500 text-white hover:bg-pink-600">
            –ù–ê–ó–ê–î –í –ú–ï–ù–Æ
        </button>
    </div>

    <!-- 5. GAME OVER SCREEN -->
    <div id="game-over-screen" class="game-screen bg-pink-100 p-8">
        <h1 class="text-5xl font-black text-red-600 mb-4 text-center">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h1>
        <p class="text-2xl font-bold mb-6">–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: <span id="finalScoreDisplay" class="text-red-600">0</span></p>
        
        <button id="restartButton" class="menu-button bg-green-500 text-white hover:bg-green-600">
            –ò–ì–†–ê–¢–¨ –°–ù–û–í–ê
        </button>
        <button id="toMenuButton" class="menu-button bg-blue-500 text-white hover:bg-blue-600">
            –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
        </button>

        <div class="mt-8 text-center text-gray-600">
             <p>–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ (—Å–∫–æ—Ä–æ)</p>
        </div>
    </div>

</div>

<!-- Game Script -->
<script type="module">
    // –ò–º–ø–æ—Ä—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===============================================
    // 1. FIREBASE & AUTH SETUP (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ê)
    // ===============================================

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'juniorchef-official';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
        apiKey: "AIzaSyDGay5I8h4NsgtUaUhCYxfEnig9y0NkD5U",
        authDomain: "juniorchef-official.firebaseapp.com",
        projectId: "juniorchef-official",
        storageBucket: "juniorchef-official.firebasestorage.app",
        messagingSenderId: "400098008130",
        appId: "1:400098008130:web:d046c604f331902d2e61db",
        measurementId: "G-NH52VFKRTB"
    }));
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userId = null;
    let isAuthReady = false;

    // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
        } else {
            if (!initialAuthToken) {
                try {
                    const anonymousUser = await signInAnonymously(auth);
                    userId = anonymousUser.user.uid;
                } catch(e) {
                    console.error("Anonymous Sign-In failed:", e);
                }
            }
        }
        isAuthReady = true;
        document.getElementById('displayUserIdSettings').textContent = userId || '–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º (ID: N/A)'; 
    });

    if (initialAuthToken) {
        signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Custom Token Sign-In failed:", e));
    }


    // ===============================================
    // 2. SCREEN MANAGEMENT & AUDIO CONTROL
    // ===============================================
    
    const BGM = document.getElementById('background-music');
    const volumeSlider = document.getElementById('volume-slider');
    const toggleMusicBtn = document.getElementById('toggle-music-btn');
    
    // –§–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –º—É–∑—ã–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    let musicAttemptedToPlay = false; 

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É–¥–∏–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    BGM.volume = 0.5; 
    
    volumeSlider.addEventListener('input', (e) => {
        BGM.volume = e.target.value;
    });

    toggleMusicBtn.addEventListener('click', () => {
        if (BGM.paused) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–í–∫–ª" ‚Äî —ç—Ç–æ —è–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.
            BGM.play().catch(e => console.error("Audio playback failed:", e));
            toggleMusicBtn.textContent = '–ú—É–∑—ã–∫–∞: –í–∫–ª.';
            toggleMusicBtn.classList.replace('bg-red-500', 'bg-green-500');
            musicAttemptedToPlay = true; // –°—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª
        } else {
            BGM.pause();
            toggleMusicBtn.textContent = '–ú—É–∑—ã–∫–∞: –í—ã–∫–ª.';
            toggleMusicBtn.classList.replace('bg-green-500', 'bg-red-500');
        }
    });
    
    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è manageMusic
    function manageMusic(screenName) {
         if (screenName === 'menu') {
             // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –º—É–∑—ã–∫—É —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
             if (!musicAttemptedToPlay && BGM.paused) {
                  // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å. 
                  BGM.play().then(() => {
                      musicAttemptedToPlay = true;
                  }).catch(e => {
                       // Silent fail or log the specific error that it needs user interaction
                       console.warn("Autoplay was blocked. Music will start after user interaction.");
                       musicAttemptedToPlay = true; // –°—á–∏—Ç–∞–µ–º –ø–æ–ø—ã—Ç–∫—É –∑–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
                  });
             }
         }
         // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ–µ –≤—ã–∫–ª—é—á–∏–ª/–≤–∫–ª—é—á–∏–ª —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É, —Å–æ—Å—Ç–æ—è–Ω–∏–µ BGM.paused —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º.
    }


    const screens = {
        intro: document.getElementById('intro-screen'),
        menu: document.getElementById('main-menu-screen'),
        game: document.getElementById('game-view'),
        gameOver: document.getElementById('game-over-screen'),
        settings: document.getElementById('settings-screen') // –ù–æ–≤—ã–π —ç–∫—Ä–∞–Ω
    };
    let currentScreen = 'intro';

    function showScreen(name) {
        Object.keys(screens).forEach(key => {
            screens[key].style.display = key === name ? 'flex' : 'none';
        });
        currentScreen = name;
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –∏ –º—É–∑—ã–∫–æ–π
        if (name === 'menu') {
            startConfetti();
        } else {
            stopConfetti();
        }
        manageMusic(name);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º/–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–≥–∏–∫—É –∏–≥—Ä—ã
        if (name === 'game') {
            if (!isGameRunning) {
               startGame();
            }
        } else if (isGameRunning) {
             isGameRunning = false;
        }
        
        if (name === 'game') {
             resizeCanvas();
        }
    }
    
    let isTransitioning = false; 
    let assetsLoaded = false; 

    function startSplashTransition() {
        if (isTransitioning || !assetsLoaded) return;
        
        isTransitioning = true;
        
        screens.intro.removeEventListener('click', startSplashTransition);
        document.removeEventListener('keydown', handleSplashKeydown);
        
        document.getElementById('splashMessage').textContent = '–°—Ç—É–¥–∏—è Asonik –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç...';
        document.getElementById('splashMessage').style.visibility = 'hidden'; 
        
        // –ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –≠—Ç–æ –ø–µ—Ä–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, –∑–∞–ø—É—Å–∫–∞–µ–º –º—É–∑—ã–∫—É –∑–¥–µ—Å—å!
        BGM.play().then(() => {
            musicAttemptedToPlay = true;
        }).catch(e => {
            console.warn("Music was blocked, requiring another user click.");
            musicAttemptedToPlay = true;
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –º–µ–Ω—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            showScreen('menu'); 
            isTransitioning = false;
        }, 3000); 
    }
    
    function handleSplashKeydown(e) {
        if (currentScreen === 'intro' && (e.code === 'Space' || e.key === 'Enter')) {
             startSplashTransition();
        }
    }

    // --- CONFETTI LOGIC (–£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞) ---
    const confettiContainer = document.getElementById('confetti-container');
    const CONFETTI_COLORS = ['#FFC0CB', '#FFD700', '#ADD8E6', '#90EE90', '#DC143C'];
    let confettiInterval = null;

    function createConfetto() {
        const confetto = document.createElement('div');
        confetto.className = 'confetto';
        confetto.style.backgroundColor = CONFETTI_COLORS[Math.floor(Math.random() * CONFETTI_COLORS.length)];
        
        const size = Math.floor(Math.random() * 10 + 10);
        confetto.style.width = `${size}px`;
        confetto.style.height = `${size / 2}px`; 
        
        confetto.style.left = `${Math.random() * 100}%`;
        
        confetto.style.animationDuration = `${Math.random() * 4 + 4}s`; 
        confetto.style.animationDelay = `-${Math.random() * 8}s`; 
        
        confetto.style.transform = `rotate(${Math.random() * 360}deg)`;
        
        confettiContainer.appendChild(confetto);

        confetto.addEventListener('animationend', () => {
            confetto.remove();
        });
    }

    function startConfetti() {
        if (confettiInterval) return;
        
        for (let i = 0; i < 50; i++) {
             createConfetto();
        }
        
        confettiInterval = setInterval(() => {
            createConfetto();
        }, 300); 
    }

    function stopConfetti() {
        if (confettiInterval) {
            clearInterval(confettiInterval);
            confettiInterval = null;
        }
        confettiContainer.innerHTML = '';
    }

    // --- ASSET LOADING (Simplified to just check auth status) ---
    function loadAssets() {
        // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
        const INGREDIENT_TYPES = ['–±–∞–∑–∞', '–≤–∞–Ω–∏–ª—å', '—à–æ–∫–æ–ª–∞–¥', '–≥–ª–∞–∑—É—Ä—å', '–≤–∏—à–Ω—è'];
        const totalAssets = INGREDIENT_TYPES.length;
        const introMessage = document.getElementById('splashMessage');

        // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        let loadedCount = 0;
        const interval = setInterval(() => {
            loadedCount++;
            introMessage.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤: ${loadedCount}/${totalAssets}`;
            if (loadedCount >= totalAssets) {
                clearInterval(interval);
                assetsLoaded = true;
                introMessage.textContent = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å...'; 
                introMessage.style.visibility = 'visible';
                
                screens.intro.addEventListener('click', startSplashTransition);
                document.addEventListener('keydown', handleSplashKeydown);
            }
        }, 100);
    }

    // Menu Button Handlers
    document.getElementById('playButton').addEventListener('click', () => {
        showScreen('game');
    });
    document.getElementById('settingsButton').addEventListener('click', () => {
        showScreen('settings');
    });
    document.getElementById('backToMenuButton').addEventListener('click', () => {
        showScreen('menu');
    });
    document.getElementById('toMenuButton').addEventListener('click', () => {
        showScreen('menu');
    });
    document.getElementById('restartButton').addEventListener('click', () => {
        showScreen('game');
    });


    // ===============================================
    // 3. GAME LOGIC (Conveyor Line) - –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ê
    // ===============================================

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const orderProgressDisplay = document.getElementById('orderProgress');
    const currentOrderDisplay = document.getElementById('currentOrderDisplay');
    const finalScoreDisplay = document.getElementById('finalScoreDisplay');

    // Game state variables
    let score = 0;
    let gameLoopRef = null;
    let isGameRunning = false;

    let currentCake = []; 
    let targetOrder = []; 
    let ingredientsOnBelt = []; 
    let currentOrderStep = 0; 

    // Constants
    const BLOCK_HEIGHT = 40;
    const BLOCK_WIDTH = 80;
    let BELT_SPEED = 1.5; 
    
    // –ü–æ–∑–∏—Ü–∏–∏
    let CONVEYOR_Y = 0; 
    let DROP_ZONE_X = 0; 
    let CAKE_BASE_Y = 0;
    const CAKE_BASE_CENTER_X_OFFSET = -20; 

    // –¢–∏–ø—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–¶–≤–µ—Ç–Ω–æ–π —Ä–µ–∂–∏–º)
    const INGREDIENTS = {
        '–±–∞–∑–∞': { display: '–ö–û–†–ñ', color: '#8B4513', img: { isFallback: true, color: '#8B4513' } },
        '–≤–∞–Ω–∏–ª—å': { display: '–í–ê–ù–ò–õ–¨', color: '#FFF8DC', img: { isFallback: true, color: '#FFF8DC' } },
        '—à–æ–∫–æ–ª–∞–¥': { display: '–®–û–ö–û–õ–ê–î', color: '#A0522D', img: { isFallback: true, color: '#A0522D' } },
        '–≥–ª–∞–∑—É—Ä—å': { display: '–ì–õ–ê–ó–£–†–¨', color: '#ADD8E6', img: { isFallback: true, color: '#ADD8E6' } },
        '–≤–∏—à–Ω—è': { display: '–í–ò–®–ù–Ø', color: '#DC143C', img: { isFallback: true, color: '#DC143C' } }
    };
    const INGREDIENT_TYPES = Object.keys(INGREDIENTS);
    let lastIngredientSpawnTime = 0;
    const SPAWN_INTERVAL = 2000; 

    
    // Adjust canvas size dynamically
    function resizeCanvas() {
        if (currentScreen !== 'game') return;

        const gameView = document.getElementById('game-view');
        const headerHeight = gameView.children[0].offsetHeight + gameView.children[1].offsetHeight;
        canvas.width = gameView.clientWidth;
        canvas.height = gameView.clientHeight - headerHeight;
        
        CONVEYOR_Y = canvas.height - BLOCK_HEIGHT - 30; 
        DROP_ZONE_X = canvas.width * 0.7 + CAKE_BASE_CENTER_X_OFFSET; 
        CAKE_BASE_Y = canvas.height - 30; 
        
        if (isGameRunning) {
            draw();
        }
    }
    window.addEventListener('resize', resizeCanvas);
    

    // --- GAME FLOW (Core) ---

    function startGame() {
        if (!assetsLoaded) {
            console.error("Assets not loaded yet!");
            return;
        }
        if (gameLoopRef) cancelAnimationFrame(gameLoopRef);
        score = 0;
        currentOrderStep = 0;
        ingredientsOnBelt = [];
        currentCake = [];
        isGameRunning = true;
        BELT_SPEED = 1.5;
        
        generateNewOrder();
        resizeCanvas(); 
        
        gameLoopRef = requestAnimationFrame(gameLoop);
    }
    
    function gameOver() {
        isGameRunning = false;
        if (gameLoopRef) cancelAnimationFrame(gameLoopRef);
        
        finalScoreDisplay.textContent = score;
        showScreen('gameOver');
    }

    // --- ORDER MANAGEMENT ---

    function generateNewOrder() {
        targetOrder = ['–±–∞–∑–∞'];
        const numLayers = 2 + Math.floor(Math.random() * 3); 
        
        for (let i = 0; i < numLayers; i++) {
            let randomType;
            do {
                randomType = INGREDIENT_TYPES[1 + Math.floor(Math.random() * (INGREDIENT_TYPES.length - 1))];
            } while (targetOrder.length > 1 && randomType === targetOrder[targetOrder.length - 1]); 
            
            targetOrder.push(randomType);
        }
        
        currentOrderStep = 0;
        currentCake = [];
        updateOrderDisplay();
        
        BELT_SPEED = Math.min(BELT_SPEED + 0.1, 4);
    }

    function updateOrderDisplay() {
        let text = '–¢—Ä–µ–±—É–µ–º—ã–π —Ç–æ—Ä—Ç: ';
        let progressHtml = '';
        
        targetOrder.forEach((type, index) => {
            const isCurrent = index === currentOrderStep;
            const status = index < currentOrderStep ? '‚úÖ' : isCurrent ? 'üü°' : '‚ö´';
            progressHtml += `<span class="px-1">${status}</span>`;
            
            const colorClass = index < currentOrderStep ? 'text-green-600' : (isCurrent ? 'text-red-600' : 'text-gray-700');
            text += `<span class="${colorClass}">${INGREDIENTS[type].display}</span> `;
            if (index < targetOrder.length - 1) text += '-> ';
        });
        
        currentOrderDisplay.innerHTML = text; 
        orderProgressDisplay.innerHTML = progressHtml;
    }
    
    function completeOrder() {
        score += targetOrder.length * 10; 
        generateNewOrder();
    }

    // --- INGREDIENT SPAWNING ---

    function spawnIngredient(timestamp) {
        const dynamicInterval = Math.max(1000, SPAWN_INTERVAL - score * 50);

        if (timestamp - lastIngredientSpawnTime > dynamicInterval) {
            const typeIndex = Math.floor(Math.random() * (INGREDIENT_TYPES.length));
            const randomType = INGREDIENT_TYPES[typeIndex];

            ingredientsOnBelt.push({
                type: randomType,
                x: -BLOCK_WIDTH, 
                y: CONVEYOR_Y,
                width: BLOCK_WIDTH,
                color: INGREDIENTS[randomType].color, 
                isDropped: false
            });
            lastIngredientSpawnTime = timestamp;
        }
    }

    // --- GAME INPUT (Drop action) ---

    if (canvas) canvas.addEventListener('click', handleDrop);
    
    function handleDrop(event) {
        if (!isGameRunning || currentScreen !== 'game') return;

        const rect = canvas.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        const clickY = event.clientY - rect.top;

        let clickedIngredient = null;
        for (const ing of ingredientsOnBelt) {
            if (!ing.isDropped && 
                clickX >= ing.x && 
                clickX <= ing.x + BLOCK_WIDTH && 
                clickY >= ing.y && 
                clickY <= ing.y + BLOCK_HEIGHT) {
                clickedIngredient = ing;
                break;
            }
        }
        
        if (!clickedIngredient) return; 

        const requiredType = targetOrder[currentOrderStep];
        
        if (clickedIngredient.type === requiredType) {
            
            clickedIngredient.isDropped = true;

            const newBlock = {
                type: clickedIngredient.type,
                width: BLOCK_WIDTH,
            };
            
            currentCake.push(newBlock);
            
            currentOrderStep++;
            score += 5; 
            updateOrderDisplay();
            
            if (currentOrderStep === targetOrder.length) {
                setTimeout(completeOrder, 500); 
            }
            
        } else {
            gameOver();
            console.log(`Wrong ingredient dropped! Needed: ${INGREDIENTS[requiredType].display}, Got: ${INGREDIENTS[clickedIngredient.type].display}`);
        }
    }


    // --- DRAWING FUNCTIONS ---

    function drawBlock(block, xPosition, yPosition) {
        const asset = INGREDIENTS[block.type];

        // Draw colored block
        ctx.fillStyle = asset.color;
        ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetY = 2;

        ctx.fillRect(xPosition, yPosition, BLOCK_WIDTH, BLOCK_HEIGHT);
        
        ctx.shadowColor = 'transparent';
        ctx.shadowBlur = 0;
        ctx.shadowOffsetY = 0;
        
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        ctx.strokeRect(xPosition, yPosition, BLOCK_WIDTH, BLOCK_HEIGHT);
        
        // Add text for prototype
        ctx.fillStyle = '#333';
        ctx.font = '10px Inter';
        ctx.textAlign = 'center';
        ctx.fillText(INGREDIENTS[block.type].display, xPosition + BLOCK_WIDTH / 2, yPosition + BLOCK_HEIGHT / 2 + 4);
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. Draw Conveyor Belt 
        ctx.fillStyle = '#654321'; 
        ctx.fillRect(0, CONVEYOR_Y + BLOCK_HEIGHT, canvas.width, 30);
        
        // 2. Draw Built Cake (fixed position near drop zone)
        if (currentCake.length > 0) {
            currentCake.forEach((block, index) => {
                const yPos = CAKE_BASE_Y - (currentCake.length - index) * BLOCK_HEIGHT;
                const xPos = DROP_ZONE_X - BLOCK_WIDTH / 2;
                drawBlock(block, xPos, yPos);
            });
        }
        
        // 3. Draw Ingredients on Belt
        ingredientsOnBelt.forEach(ing => {
            if (!ing.isDropped) {
               drawBlock(ing, ing.x, CONVEYOR_Y);
            }
        });

        scoreDisplay.textContent = score;
    }

    // --- GAME UPDATE ---

    function update(timestamp) {
        spawnIngredient(timestamp);
        
        ingredientsOnBelt.forEach(ing => {
            if (!ing.isDropped) {
                ing.x += BELT_SPEED;
            }
        });

        ingredientsOnBelt = ingredientsOnBelt.filter(ing => {
            if (!ing.isDropped && ing.x > canvas.width) {
                gameOver();
                return false;
            }
            return ing.x < canvas.width;
        });
    }

    // --- GAME LOOP ---

    function gameLoop(timestamp) {
        if (!isGameRunning) return;
        
        update(timestamp);
        draw();
        
        gameLoopRef = requestAnimationFrame(gameLoop);
    }
    
    // Ensure the first screen is shown on load and start asset loading
    window.onload = function () {
        loadAssets(); 
        showScreen('intro');
    }

    // ===============================================
    // 4. FIREBASE HIGH SCORE FUNCTIONS (Future step)
    // ===============================================
    /*
    async function saveHighScore(finalScore) {
        if (!isAuthReady || !userId) {
            console.warn("Auth not ready or User ID missing. Cannot save score.");
            return;
        }

        try {
            await addDoc(collection(db, SCORES_COLLECTION_PATH), {
                userId: userId,
                score: finalScore,
                timestamp: Date.now()
            });
            console.log("Score saved successfully!");
        } catch (e) {
            console.error("Error saving score: ", e);
        }
    }
    */
</script>
</body>
</html>
